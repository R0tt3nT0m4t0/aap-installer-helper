= AAP RPM Installation 2.5

Author: Juan Medina

Email: jumedina@redhat.com

== Requirements

. Six Machines with Red Hat Enterprise Linux (RHEL) 9.2 or later
+
- automationgateway
- automationcontroller
- automationhub
- automationedacontroller
- executionnode1
- automationdatabase

. Minimal Specs: (Because mine is a sandbox environment I used half of the minimum recommendations for CPU and RAM)
+

- Control nodes    16GB RAM, 4 CPUs, 80GB minimum + 20GB allocated to /var/lib/awx
- Automation hub   16GB RAM, 4 CPUs, 40GB minimum + 40GB allocated to /var/lib/pulp
- Database         16GB RAM, 4 CPUs, 40GB minimum + 200GB allocated to /var/lib/pgsql
- Platform gateway 16GB RAM, 4 CPUs, 40GB minimum 
- Execution nodes  16GB RAM, 4 CPUs, 40GB minimum
- Hop nodes        16GB RAM, 4 CPUs, 40GB minimum
- EDA controller   16GB RAM, 4 CPUs, 40GB minimum

. Ansible-core version 2.16 or later
. Python 3.8 or later

== RHEL OS Installation

. Register the system to RHN
. Software selection "minimal install"
. Network & Hostname: Ideally you will have an static IP, in my case it will be Dynamic so all I need to change is the hostname to:

- `automationcontroller.home.lab`
- `automationhub.home.lab`
- `automationdatabase.home.lab`
- `automationgateway.home.lab`
- `executionnode1.home.lab`
- `hopnode1.home.lab`
- `automationedacontroller.home.lab`

. Set a root password, in my case I'll allow SSH
. Create the user ansible
+
image::images/ansible_user.png[align="center"]

All systems can remain as configured by default except: Controller, Hub and Database on which you will:

. Select the storage disk with custom configuration:
.. Click the "Click here to create them automatically" link making sure you have LVM selected.
.. Reduce the size of the `/home` logical volume as needed, in my case 5GB
.. Reduce the space of the `/` logical volume as needed, in my case 40GB
.. Add a new logical volume as follows:

Automation Controller with at least 20GB in `/var/lib/awx`
Automation Hub with at least 40GB in `/var/lib/pulp`
Automation Database with at least 200GB in `/var/lib/pgsql`

Example:

image::images/disk_conf_controller.png[align="center"]

== Bastion System

The bastion system could be your own workstation or a virtual machine that can be decommissioned once the installation is completed.

. Get the IP Addresses for all the systems that will be part of the cluster
+
In my case since I am using KVM Virtual Machines I can get that information with the following command (a bit filtered to get clean info)
+
[source,shell]
----
$ virsh net-dhcp-leases default | awk '{print $5,$6}' | sed 's|/24||g' | grep '^1'
192.168.122.131 automationdatabase
192.168.122.141 automationgateway
192.168.122.187 automationcontroller
192.168.122.106 executionnode1
192.168.122.125 automationedacontroller
192.168.122.114 automationhub
----
+
note: In my case even when I didn't assigned static IPs KVM does lease IPs based on MACs which means these won't be changed over time.

. Register the names in the host table of the bastion
+
[source,shell]
----
include::rpm2.5.hosts[]
----

. Create an inventory file with these systems to be used with the pre-configuration.yml playbook
+
[source,ini]
----
include::rpm2.5-inventory.yml[]
----

Before we can run the playbook to configure the requirements we need to create the SSH key for the ansible user in the bastion system and share it across all the systems of the AAP cluster

[source,bash]
----
ssh-keygen -t rsa -b 4096
chmod 700 ~/.ssh
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chown -R $USER:$USER ~/.ssh
----

Now let's copy the key to all the systems

[source,bash]
----
ssh-copy-id -i ~/.ssh/id_rsa.pub automationcontroller.home.lab
ssh-copy-id -i ~/.ssh/id_rsa.pub automationgateway.home.lab
ssh-copy-id -i ~/.ssh/id_rsa.pub automationhub.home.lab
ssh-copy-id -i ~/.ssh/id_rsa.pub automationedacontroller.home.lab
ssh-copy-id -i ~/.ssh/id_rsa.pub automationdatabase.home.lab
ssh-copy-id -i ~/.ssh/id_rsa.pub executionnode1.home.lab
----


. Run the pre-configuration.yml playbook with the command:

[source,bash]
----
ansible@server:~$ ansible-playbook -i rpm2.5-inventory.yml -K rpm2.5-pre-configuration.yml
----

The playbook will perform the following actions:

. Register all the cluster systems in the host table to guarantee name resolution
. Ensure the installer user exist, has sudo access, has the correct permissions of SSH files and can linger services
. Ensure the correct permissions of SSH files for root


[source,yaml]
----
include::rpm2.5-pre-configuration.yml[]
----

#TODO: Include a list of the actions performed by the playbook

- 

== Network Requirements

[%header,cols="1,5"]
|===
| Port Protocol | Source -> Destination
| 22 TCP        | bastion                  -> to all machines (temporary)
| 80/443 TCP    | automationedacontroller  -> automationhub
| 80/443 TCP    | automationedacontroller  -> automationcontroller
| 80/443 TCP    | automationcontroller     -> automationhub
| 80/443 TCP    | automationgateway        -> automationcontroller
| 80/443 TCP    | automationgateway        -> automationhub
| 80/443 TCP    | automationgateway        -> automationedacontroller
| 80/443 TCP    | bastion                  -> automationhub
| 80/443 TCP    | executionnode1           -> automationhub
| 80/443 TCP    | HAProxy LB               -> automationgateway
| 80/443 TCP    | HAProxy LB               -> automationcontroller
| 80/443 TCP    | HAProxy LB               -> automationedacontroller
| 5432 TCP      | automationedacontroller  -> automationdatabase
| 5432 TCP      | automationgateway        -> automationdatabase
| 5432 TCP      | automationhub            -> automationdatabase
| 5432 TCP      | automationcontroller     -> automationdatabase
| 6379 TCP      | automationedacontroller  -> automationgateway (redisnode)
| 6379 TCP      | automationgateway        -> automationgateway (redisnode)
| 8443 TCP      | automationgateway        -> automationgateway
| 8443 TCP      | automationgateway        -> edaexecutionnodes (*all) 
| 16379 TCP     | redisnodes               -> redisnodes (*only redis clustered)
| 27199 TCP     | automationcontroller  <<-bi->> executionnode1 (*all execution nodes)
| 27199 TCP     | automationcontroller     -> hopnode (*all hop nodes)
| 27199 TCP     | automationcontroller     -> hybridnode (*all hybrid nodes)
| 27199 TCP     | executionnodes        <<-bi->> hopnode as required per distribution
|===

== Remotes

=== Red Hat Insights

- https://api.access.redhat.com:443       General account services, subscriptions
- https://cert-api.access.redhat.com:443  Insights data upload
- https://cert.console.redhat.com:443     Inventory upload and Cloud Connector connection
- https://console.redhat.com:443          Access to Insights dashboard

=== Automation Hub

- https://console.redhat.com:443          General account services, subscriptions
- https://catalog.redhat.com:443          Indexing execution environments
- https://sso.redhat.com:443
- https://automation-hub-prd.s3.amazonaws.com
- https://automation-hub-prd.s3.us-east-2.amazonaws.com

=== Firewall access

- https://galaxy.ansible.com:443          Ansible Community curated Ansible content
- https://ansible-galaxy-ng.s3.dualstack.us-east-1.amazonaws.com  Dual Stack IPv6 endpoint for Community curated Ansible content repository
- https://registry.redhat.io:443          Access to container images provided by Red Hat and partners
- https://cert.console.redhat.com:443     Red Hat and partner curated Ansible Collections

Execution Environments (EE)

- https://registry.redhat.io:443          Access to container images provided by Red Hat and partners
- cdn.quay.io:443 and cdn[01 to 06].quay.io:443        Access to container images provided by Red Hat and partners

== On gateway an Hop Nodes

You are required to set umask=0022.

== On Automation Hub

If using more than one Automation Hub Controller

verify that you installed the `/var/lib/pulp` directory across your cluster as part of the shared storage file system installation

If HA will be enabled

you must first install and use `firewalld` to open the necessary ports as required by your shared storage system before running the Ansible Automation Platform installer.

Install the firewalld daemon:

[source,bash]
----
$ dnf install firewalld
----

Add your network storage under and reload:

[source,bash]
----
$ firewall-cmd --permanent --add-service=<service>
$ firewall-cmd --reload
----

== On the database

To determine if your automation controller instance has access to the database, you can do so with the command, `awx-manage check_db` command.

== Upgrade

Upgrade all the systems and reboot

[source,shell]
----
dnf -y upgrade 
systemctl reboot
----

== Download AAP

*On the bastion*

https://access.redhat.com/downloads/content/480/ver=2.5/rhel---9/2.5/x86_64/product-software

- For online installations: Ansible Automation Platform 2.5
- For offline or bundled installations: Ansible Automation Platform 2.5 Setup Bundle

Copy the package to your system and extract it as the user `ansible`

Also copy the zip file for the license (Do not extract this one)

[source,shell]
----
scp ansible-automation-platform-containerized-setup-2.5-10.tar.gz ansible@aap.home.lab:~
scp c57ede26-dae3-4811-a854-2ed0f1a73c54.zip ansible@aap.home.lab:~
tar xfvz ansible-automation-platform-containerized-setup-*.tar.gz
cd ansible-automation-platform-containerized-setup-*
----

== Inventory for RPM Growth Topology

Considering in my environment the following hostnames

- automationgateway.home.lab
- automationcontroller.home.lab
- automationhub.home.lab
- automationedacontroller.home.lab
- executionnode1.home.lab
- automationdatabase.home.lab


[source,yaml]
----
[automationgateway]
automationgateway.home.lab

[automationcontroller]
automationcontroller.home.lab 

[automationcontroller:vars]
node_type=control
peers=execution_nodes

[execution_nodes]
executionnode1.home.lab node_type=execution

[automationhub]
automationhub.home.lab

[automationedacontroller]
automationedacontroller.home.lab

[database]
automationdatabase.home.lab

[all:vars]
registry_username=<your RH username>
registry_password=<your RH password>
redis_mode=standalone
controller_license_file=/home/ansible/c57ede26-dae3-4811-a854-2ed0f1a73c54.zip
bundled=false
enable_insights_collection=true

automationgateway_pg_host=automationdatabase.home.lab
automationgateway_pg_password=redhat123
automationgateway_admin_password=redhat123

automationhub_pg_host=automationdatabase.home.lab
automationhub_pg_password=redhat123
automationhub_admin_password=redhat123
automationhub_seed_collections=true

automationedacontroller_pg_host=automationdatabase.home.lab
automationedacontroller_pg_password=redhat123
automationedacontroller_admin_password=redhat123

pg_host=automationdatabase.home.lab
pg_port=5432
pg_password=redhat123
admin_password=redhat123
----

== Installation 

NOTE: If need to be prompted for password add the option `-K` to the following command.

[source,shell]
----
export ANSIBLE_BECOME_METHOD='sudo'
export ANSIBLE_BECOME=True
./setup.sh -i inventory-growth
----

IMPORTANT: *Go get a coffee!*

== A Healthy Running System

Expected services

[source,shell]
----
----
